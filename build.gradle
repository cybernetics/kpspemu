import org.apache.tools.ant.taskdefs.condition.Os
import org.apache.tools.ant.taskdefs.condition.Os

buildscript {
    repositories {
        mavenLocal()
        jcenter()
        maven { url "https://dl.bintray.com/soywiz/soywiz" }
        maven { url "https://dl.bintray.com/jetbrains/kotlin-native-dependencies" }
        maven { url 'https://dl.bintray.com/kotlin/kotlin-eap' }
        maven { url 'https://dl.bintray.com/kotlin/kotlin-dev' }
        maven { url "https://plugins.gradle.org/m2/" }
    }

    dependencies {
        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlinVersion"
        classpath "org.jetbrains.kotlin:kotlin-native-gradle-plugin:$kotlinNativeVersion"
    }

    ext.nativeTargets = ["macos_x64", "linux_x64", "mingw_x64"]

    ext.libDependencies = [
            "kpspemu": [
                    "com.soywiz:dynarek{SUFFIX}:$korlibsVersion",
                    "com.soywiz:korge{SUFFIX}:$korlibsVersion",
                    "com.soywiz:korau-atrac3plus{SUFFIX}:$korlibsVersion",
                    "com.soywiz:krypto{SUFFIX}:$korlibsVersion",
            ],
    ]
    ext.libExecutables = [
            "kpspemu": true
    ]
}

new File(rootProject.rootDir, "kpspemu/common/src/com/soywiz/kpspemu/KpspemuVersion.kt").write(
        "package com.soywiz.kpspemu\n\nval KPSPEMU_VERSION = \"$version\""
)


allprojects {
    def isJs = project.name.endsWith("-js")
    def isJvm = project.name.endsWith("-jvm")
    def isNative = project.name.endsWith("-native")
    def isCommon = project.name.endsWith("-common")
    def isKotlin = isJs || isJvm || isNative || isCommon

    String suffix = ""
    String jsuffix = ""
    String projectNameWithoutSuffix = project.name[0..<project.name.lastIndexOf('-')]

    if (isJs) jsuffix = suffix = "-js"
    if (isJvm) {
        suffix = "-jvm"; jsuffix = ""
    }
    if (isNative) jsuffix = suffix = "-native"
    if (isCommon) jsuffix = suffix = "-common"

    ext.suffix = suffix
    ext.jsuffix = jsuffix

    if (suffix != "") {
        apply plugin: "kotlin-platform$suffix"
    }
    if (!isNative) {
        apply plugin: "java"
    }

    repositories {
        mavenLocal()
        jcenter()
        maven { url "https://dl.bintray.com/soywiz/soywiz/" }
        maven { url "https://plugins.gradle.org/m2/" }
        maven { url "https://dl.bintray.com/jetbrains/kotlin-native-dependencies" }
        maven { url 'https://dl.bintray.com/kotlin/kotlin-eap' }
        maven { url 'https://dl.bintray.com/kotlin/kotlin-dev' }
        mavenCentral()
    }

    dependencies {
        if (isKotlin && !isNative) {
            compile "org.jetbrains.kotlin:kotlin-stdlib${jsuffix}:$kotlinVersion"

            testCompile "org.jetbrains.kotlin:kotlin-test${jsuffix}:$kotlinVersion"
            if (isCommon) {
                testCompile "org.jetbrains.kotlin:kotlin-test-annotations-common:$kotlinVersion"
            }
        }
        if (isJvm) {
            testCompile "org.jetbrains.kotlin:kotlin-test-junit:$kotlinVersion"
            testCompile "junit:junit:4.12"
        }

        if (isKotlin) {
            //println("----")
            if (!isCommon) {
                def expect = ":${projectNameWithoutSuffix}-common"
                expectedBy project(expect)
                if (!isNative) {
                    testImplementation project(expect)
                }
                //println("EXP: ${project.name}: ${expect}")
            }

            for (String dep in libDependencies[projectNameWithoutSuffix]) {
                String rdep = dep.replace("{SUFFIX}", suffix).replace("{JSUFFIX}", jsuffix)
                def rdepm
                if (dep.contains(":")) {
                    rdepm = rdep
                } else {
                    rdepm = findProject(":${rdep}${suffix}")
                }
                if (rdepm != null) {
                    //println("DEP: ${project.name}: ${rdepm}")
                    if (isNative) {
                        implementation rdepm
                    } else {
                        compile rdepm
                    }
                }
            }
        }

        sourceSets {
            if (isKotlin) {
                //println("IS KOTLIN")
                main.kotlin.srcDirs += "src"
                test.kotlin.srcDirs += "test"
                if (!isNative) {
                    main.resources.srcDirs += "resources"
                    test.resources.srcDirs += "testresources"
                }
                if (!isCommon && !isNative) {
                    // @TODO: @BUG: Hack. No common resources are copied
                    main.resources.srcDirs += ['../common/resources']
                    test.resources.srcDirs += ['../common/testresources']
                }

                if (isNative) {
                    main {
                        component {
                            target nativeTargets
                            if (libExecutables[projectNameWithoutSuffix]) {
                                outputKinds = [EXECUTABLE]
                            } else {
                                outputKinds = [KLIBRARY]
                            }
                        }
                    }
                }
            }
        }

        if (isKotlin && !isNative) {
            kotlin.experimental.coroutines 'enable'
        }

        if (isJs) {
            [compileKotlin2Js, compileTestKotlin2Js]*.configure {
                kotlinOptions.moduleKind = "umd"
                kotlinOptions.sourceMap = true
            }
        }
    }
}

apply plugin: 'idea'

idea {
    module {
        excludeDirs += [file('psplibdoc'), file('gradle'), file('kpspemu/js/web')]
    }
}
